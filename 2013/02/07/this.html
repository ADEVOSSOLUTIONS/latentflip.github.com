<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>This</title>
    <link rel='stylesheet' href='/assets/stylesheets/app.css'>

    <script src='/assets/javascripts/jquery.js'></script>
    <script src='/assets/javascripts/underscore-min.js'></script>
    <script src='/assets/javascripts/angular.js'></script>
    <script src='/assets/javascripts/app.js'></script>
  </head>
  <body>
    <main ng-app='blog'>
      <div ng-controller='PostCtrl'>
  <div class="post post-text post-code">
  <h1>This</h1>
  <p>JavaScript&#39;s <code>this</code> can be confusing.</p>

<p><code>this</code> is the context that a JavaScript function is run in. Since functions are first class objects in JavaScript, they can be passed around, and reused as you see fit. But often we want to run them in the context of an object so that we can interact with the object from within a function.</p>

<p>Note: a function&#39;s <code>this</code> and a function&#39;s scope are <em>different things</em>.</p>

<h2>First Steps</h2>

<p>When a function which is not bound to any given object, the default value for <code>this</code> is the global context (object). In the browser this is <code>window</code>.</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">myFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&quot;this&quot; is:&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">myFunc</span><span class="p">();</span>
</code></pre></div>

<h2>Objects</h2>

<p>If the function is a property on another object, (this is known as a method) and we call it as a method on that object <code>this</code> will be set to that object. In this example, since we call <code>dog.greet()</code>, <code>this</code> is <code>dog</code>:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>
</code></pre></div>

<h2>Passing functions around</h2>

<p>Since functions are first class objects, we can pass them around, just like any other object. When we do that <code>this</code> doesn&#39;t remain bound to the original object. This is where much of the confusion about <code>this</code> comes from:</p>

<p>In this example, when we call <code>greet</code> as a method on <code>dog</code> it is bound to that object, so <code>this.color</code> is defined. But when we pass <code>dog</code>&#39;s <code>greet</code> function around, and assign it to <code>var myFunction</code> and call that, it&#39;s an unbound function, so <code>this</code> is now <code>window</code>, and <code>this.color</code> is undefined.</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//call `greet` as a method on `dog`</span>
<span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>

<span class="c1">//assign `dog.greet` to a variable, `myFunction` and call that</span>
<span class="kd">var</span> <span class="nx">myFunction</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">;</span>
<span class="nx">myFunction</span><span class="p">();</span>
</code></pre></div>

<h2>Callback functions</h2>

<p>The first place time many people get tripped up by this behaviour is when they use object methods in callback functions, typically when using jQuery or <code>setTimeout</code>/<code>setInterval</code></p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//calls dog.greet after 0.5 seconds.</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div>

<p>So what&#39;s happening here? It <em>looks</em> like <code>setTimeout</code> should be calling the method on <code>dog</code> and all should work as we would expect. But <code>setTimeout</code> isn&#39;t calling a method on dog, it&#39;s receiving a reference to a function, which it calls after the timeout. So the above code is effectively the same as:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">myFunction</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">;</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">myFunction</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div>

<p>Which as we saw before, will unbind <code>greet</code> from <code>dog</code> and <code>this</code> will be the global object again. Sigh!</p>

<p>So how can we deal with this? We want to call <code>dog.greet</code> after 0.5 seconds, and we want <code>greet</code> to still be bound to dog. One way is to not pass <code>dog.greet</code> to <code>setTimeout</code> directly, but to call it from within another function:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
</code></pre></div>

<p>Yay!</p>

<h2>Binding</h2>

<p>We&#39;ve used the word binding a couple of times. And you may have come across <code>bind</code> functions. <strong>Note, this is different to jQuery&#39;s (now deprecated) <code>bind()</code> function (now known as <code>on()</code>).</strong></p>

<p>Underscore has <code>_.bind</code> and JavaScript functions themselves have <code>function.bind()</code> in <em>most</em> browsers (not IE &lt; 8). And if you have used CoffeeScript you may have come across the fat-arrow (<code>=&gt;</code>) which binds functions too.</p>

<p>So what does <code>bind</code> generally do? Bind ensures that no matter how we call a function, it&#39;s <code>this</code> will always be the object we expect it to be.</p>

<p>We already sort of know how to do this, as we saw in the last example. We could even modify the <code>greet</code> method a little so that we wouldn&#39;t have to remember to wrap it in a function before we called it from <code>setTimeout</code>. This is a little ugly but it works:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//Save our original greet function</span>
<span class="nx">dog</span><span class="p">.</span><span class="nx">oldGreet</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">;</span>
<span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">dog</span><span class="p">.</span><span class="nx">oldGreet</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//This now works</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

<span class="c1">//As does this</span>
<span class="kd">var</span> <span class="nx">myFunction</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">;</span>
<span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>
</code></pre></div>

<p>By replacing our <code>greet()</code> method with a new method which <em>always</em> calls the original <code>greet()</code> function (now <code>oldGreet</code>) directly on <code>dog</code>, <code>this</code> will always be <code>dog</code>.</p>

<h2>Our own <code>bind</code> function</h2>

<p>So could we create a function, which given an object, and the name of one of it&#39;s methods, could do that work for us?</p>

<p>Sure we can, let&#39;s call it <code>myBind</code>. <code>myBind</code> will take an object, and the name of one of it&#39;s methods, and ensure that whenever the method is called, <code>this</code> will always be the object.</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">myBind</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">oldMethodName</span> <span class="o">=</span> <span class="s2">&quot;old_&quot;</span><span class="o">+</span><span class="nx">methodName</span><span class="p">;</span>

  <span class="c1">//Set obj.old_methodName to our original method</span>
  <span class="nx">obj</span><span class="p">[</span><span class="nx">oldMethodName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span>

  <span class="c1">//Overwrite our original method name with a method</span>
  <span class="c1">//which calls the original one, but bound to obj</span>
  <span class="nx">obj</span><span class="p">[</span><span class="nx">methodName</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">[</span><span class="nx">oldMethodName</span><span class="p">]();</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
  <span class="nx">greet</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span> <span class="s2">&quot; dog barked.&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//Bind &#39;greet&#39; on dog.</span>
<span class="nx">myBind</span><span class="p">(</span><span class="nx">dog</span><span class="p">,</span> <span class="s1">&#39;greet&#39;</span><span class="p">);</span>

<span class="c1">//This now works</span>
<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>

<span class="c1">//As does this</span>
<span class="kd">var</span> <span class="nx">myFunction</span> <span class="o">=</span> <span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">;</span>
<span class="nx">dog</span><span class="p">.</span><span class="nx">greet</span><span class="p">();</span>
</code></pre></div>

<p>But <code>myBind</code> has a couple of limitations. First we can only bind to the original owner of the object. It&#39;s also a little ugly to have lots of <code>old_greet</code> methods lying around. And finally our bound methods currently couldn&#39;t accept any arguments, as they wouldn&#39;t be passed through by bind.</p>

<h2>Call and apply</h2>

<p>If we want to call a function within the context of a different object, we can do so using <code>call()</code> and passing in our context object. Think of it like &quot;borrowing&quot; a function from somewhere else, and using it on our own object.</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">myFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;&quot;this&quot; is:&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ears</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;red&quot;</span> <span class="p">};</span>
<span class="nx">myFunc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">dog</span><span class="p">);</span>
</code></pre></div>

<p>If the function you are applying takes its own arguments, you can just pass them to apply after your object:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">eat</span><span class="p">(</span><span class="nx">foodType</span><span class="p">,</span> <span class="nx">adjective</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span>
              <span class="s2">&quot; dog eats the &quot;</span> <span class="o">+</span> <span class="nx">foodType</span> <span class="o">+</span>
              <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">adjective</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ears</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;red&quot;</span> <span class="p">};</span>

<span class="nx">eat</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">dog</span><span class="p">,</span> <span class="s2">&quot;bone&quot;</span><span class="p">,</span> <span class="s2">&quot;hungrily&quot;</span><span class="p">);</span>
</code></pre></div>

<p>There is a very similar function to <code>call()</code> called <code>apply()</code>. The <em>only</em> difference is that the &quot;extra arguments&quot; in <code>apply()</code> have to be provided as an array:</p>

<div class="highlight"><pre><code class="javascript"><span class="kd">function</span> <span class="nx">eat</span><span class="p">(</span><span class="nx">foodType</span><span class="p">,</span> <span class="nx">adjective</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The &quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">color</span> <span class="o">+</span>
              <span class="s2">&quot; dog eats the &quot;</span> <span class="o">+</span> <span class="nx">foodType</span> <span class="o">+</span>
              <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">adjective</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">dog</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">ears</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">color</span><span class="o">:</span> <span class="s2">&quot;red&quot;</span> <span class="p">};</span>

<span class="c1">//Note that we have to use an array here</span>
<span class="nx">eat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">dog</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;carrot&quot;</span><span class="p">,</span> <span class="s2">&quot;slowly&quot;</span><span class="p">]);</span>
</code></pre></div>

</div>

</div>

<nav>
  <a href="/2013/01/31/dont-compare-your-behind-the-scenes-to-someone.html">←</a>
  <a href="/">⚑</a>
  <a href="">→</a>
</nav>

    </main>
  </body>
</html>
